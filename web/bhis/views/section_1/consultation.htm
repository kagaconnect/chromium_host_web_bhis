<div class="FlexDisplay FlexColumn container"  style="margin:0px; padding:0px; height:100%;">
	<div class="FlexDisplay" style="background:#535FD7; height:48px; box-shadow:0 1px 2px rgba(0, 0, 0, 0.3);" >
		<div id="backBtn"  class="nav-button" >
			<i class="mdi mdi-apps"></i>
		</div>
		<div class="FlexDisplay">
			<span class="BHIS-Title" style="white-space:nowrap; overflow:hidden; text-overflow: ellipsis; font-weight:normal; font-size:12px; color:#ffffff; margin:auto 8px;">Basic Laboratory Information System</span>
		</div>
		<div class="FlexDisplay FlexGrow" style="height:100%;"></div>
		<div class="search dropdown" tooltip="search" flow="down">
			<div class="nav-button transparent dropdown">
				<i class="mdi mdi-account-search"></i>
			</div>
			<div class="submenu">
				<ul class="root"/>
			</div>
		</div>
		<div class="clear dropdown" tooltip="clear" flow="down">
			<div class="nav-button transparent dropdown">
				<i class="mdi mdi-rotate-left"></i>
			</div>
			<div class="submenu">
				<ul class="root"/>
			</div>
		</div>
		<div class="save dropdown" tooltip="save" flow="down">
			<div class="nav-button transparent dropdown">
				<i class="mdi mdi-check-circle"></i>
			</div>
			<div class="submenu">
				<ul class="root"/>
			</div>
		</div>
	</div>
	<div class="FlexDisplay Flex ContentPage  inner-section FadeIn"  style="width:100%; height:1px;">		
		<div class="FlexDisplay FlexColumn FlexGrow FlexBoxSizing-BorderBox" style="height:100%; position:relative;">
			<div class="FlexDisplay" style="margin:16px 16px 0px 16px; height:218px;">
				<div class="page-container FlexDisplay Flex FlexRow Overflow-Hidden inner-container Round Shadow" style="position:relative; height:calc(100% - 0px);  width:100%;">
					<div class="FlexDisplay FlexColumn Divider-Right" style="height:calc(100% - 0px); max-width:412px;min-width:412px;">
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">CONSULTATION</h4>
							</div>
							<div class="FlexDisplay btn-clear Divider-Left" onclick="filterConsultation(this,event)">
								<div style="margin:auto auto; width:16px height:16px; padding:0px 12px; font-size: 14px;"><i class="mdi mdi-calendar-search" /></div>
							</div>
						</div>
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;  height:calc(100% - 12px); z-index:2;">
							<div class="ConsultationPendingList FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="overflow-y:auto; height:calc(100% - 20px);">
							</div>
						</div>	
					</div>
					<div class="FlexDisplay FlexGrow FlexColumn" style="height:calc(100% - 0px);">
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">PATIENT INFORMATION</h4>
							</div>
						</div>
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;  height:calc(100% - 32px); z-index:2;">
							<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="overflow-y:auto; height:calc(100% - 0px);">
								
								<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">First Name</h4>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">Middle Name</h4>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 4px; font-size: 12px; font-weight:normal; line-height:16px;">Last Name</h4>
									</div>
								</div>
								<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:0px 8px;">						
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 0px;">
											<div class="icon">
												<i class="mdi mdi-account" />
											</div>
											<input readonly type="text" class="FirstName" placeholder="First Name"/>
										</div>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-account" />
											</div>
											<input readonly type="text" class="MiddleName" placeholder="Midle Name"/>
										</div>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 0px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-account" />
											</div>
											<input readonly type="text" class="LastName" placeholder="Last Name"/>
										</div>
									</div>
								</div>
								
								
								<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Gender</h4>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">Date Of Birth</h4>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 4px; font-size: 12px; font-weight:normal; line-height:16px;">Phone Number</h4>
									</div>
								</div>
								<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:0px 8px;">						
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="Flex btn-group btn-group-toggle gender" data-toggle="buttons" style="margin:0px 4px 0px 0px;">
											<label class="btn btn-color" tooltip="Ambiguous" flow="right">
												<input value="A" type="radio" name="gender_options" autocomplete="off"><div style="width:8px; height:8px; margin:auto auto;">A</div>
											</label>
											<label class="btn btn-color" tooltip="Female" flow="up">
												<input value="F" type="radio" name="gender_options" autocomplete="off"><div style="width:8px; height:8px; margin:auto auto;">F</div>
											</label>
											<label class="btn btn-color" tooltip="Male" flow="up">
												<input value="M" type="radio" name="gender_options" autocomplete="off"><div style="width:8px; height:8px; margin:auto auto;">M</div>
											</label>
											<label class="btn btn-color" tooltip="Not applicable" flow="up">
												<input value="N" type="radio" name="gender_options" autocomplete="off"><div style="width:8px; height:8px; margin:auto auto;">N</div>
											</label>
											<label class="btn btn-color" tooltip="Other" flow="up">
												<input value="O" type="radio" name="gender_options" autocomplete="off"><div style="width:8px; height:8px; margin:auto auto;">O</div>
											</label>
											<label class="btn btn-color" tooltip="Unknown" flow="up">
												<input value="U" type="radio" name="gender_options" autocomplete="off" value=""><div style="width:8px; height:8px; margin:auto auto;">U</div>
											</label>
										</div>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-calendar-outline" />
											</div>
											<input readonly class="DateOfBirth" type="text" placeholder="dd/mm/yyyy" class="datepicker-range-dob" style="padding:0px 0px 0px 8px;"/>
											<!--<div id="age-manual" class="icon btn-color Divider-Left"  style="border-radius: 0 4px 4px 0; min-width:32px; max-width:32px;">
												<i class="mdi mdi-calendar-search" />
											</div>-->
										</div>
									</div>
									<div class="FlexDisplay Flex" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-cellphone-basic" />
											</div>
											<input readonly class="PhoneNumber" id="phone_number" type="text" placeholder="Phone Number"/>
										</div>
									</div>
								</div>
								
								<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
									<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Address</h4>
									</div>
									<div class="FlexDisplay Flex FlexGrow" style="min-width:130px;">
										<h4 class="feature-title mt-0" style="margin:0px 0px 0px 4px; font-size: 12px; font-weight:normal; line-height:16px;">Email</h4>
									</div>
								</div>
								<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:0px 8px;">
									<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-earth" />
											</div>
											<input readonly class="Address" type="text" placeholder="Address"/>
										</div>
									</div>
									<div class="FlexDisplay Flex FlexGrow" style="min-width:130px;">
										<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
											<div class="icon">
												<i class="mdi mdi-at" />
											</div>
											<input readonly class="EmailAddress" id="email_address" type="text" placeholder="Address"/>
										</div>
									</div>
								</div>
							
							</div>
						</div>			
					</div>			
				</div>
			</div>
			<div class="FlexDisplay Flex FlexGrow" style="margin:16px 16px 16px 16px; height:calc(100% - 256px);"> <!-- height:calc(50% - 0px); overflow: hidden; -->
				<div class="page-container FlexDisplay Flex FlexRow inner-container Round Shadow" style="position:relative; height:calc(100% - 0px);  width:100%;">
					<div class="FlexDisplay FlexColumn Divider-Right" style="height:calc(100% - 0px); width:200px;">
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">HISTORY</h4>
							</div>
						</div>
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;  height:calc(100% - 0px); z-index:2;">
							<div class="HistoryList FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="overflow-y:auto; height:calc(100% - 32px);">
								
							</div>
						</div>	
					</div>
					<div class="FlexDisplay FlexColumn" style="height:calc(100% - 0px); width:212px;">
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0 testsTitle" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">TESTS - 0.00</h4>
							</div>							
							<div tooltip="add test" flow="left" id="addTests" class="FlexHidden btn-clear">
								<div style="margin:auto auto; width:14px height:14px; padding:0px 14px; font-size:14px;"><i class="mdi mdi-flask-plus-outline" /></div>
							</div>
						</div> <!--overflow-y:auto;  overflow-x: hidden !important; -->
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox Divider-Bottom" style="width:100%;  min-height:calc(50% - 32px); max-height:calc(50% - 32px); z-index:2;">
							<div class="TestsList FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="">
								
							</div>
						</div>
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0 prescriptionsTitle" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">MEDS - 0.00</h4>
							</div>														
							<div tooltip="add prescription" flow="left" id="addPrescriptions" class="FlexHidden btn-clear">
								<div style="margin:auto auto; width:14px height:14px; padding:0px 14px; font-size:14px;"><i class="mdi mdi-pill" /></div>
							</div>
						</div>
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;  min-height:calc(50% - 32px); max-height:calc(50% - 32px); z-index:2;">
							<div class="PrescriptionsList FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="overflow-y:auto; height:calc(100% - 0px);">
								
							</div>
						</div>
					</div>
					<div class="FlexDisplay FlexGrow FlexColumn Divider-Left" style="height:calc(100% - 0px);">
						<div class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; max-height:32px;" >
							<div class="FlexDisplay Flex">
								<h4 class="feature-title mt-0" style="margin:8px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px; white-space: nowrap;">EXAMINATION, DIAGNOSIS & TREATMENT</h4>
							</div>
						</div>
						<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;  height:calc(100% - 32px); z-index:2;">
							<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2" style="overflow-y:auto; height:calc(100% - 0px);">
							
							<!--style="min-height:128px;max-height:128px;"-->
								<div class="FlexDisplay FlexGrow FlexColumn"  >
									<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Examination</h4>
										</div>
									</div>
									<div class="FlexDisplay FlexRow"  style="width:100%; height:calc(100% - 16px); padding:0px 8px;">
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
												<div class="icon">
													<i class="mdi mdi-earth" />
												</div>
												<textarea class="scroll scroll2 Examination" type="text" placeholder="Examination" style="padding: 8px 8px 8px 0px; line-height: 1.15; min-height:30px;"/>
											</div>
										</div>
									</div>
								</div>
								
								<div class="FlexDisplay FlexGrow FlexColumn"  >
									<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Treatment</h4>
										</div>
									</div>
									<div class="FlexDisplay FlexRow"  style="width:100%; height:calc(100% - 16px); padding:0px 8px;">
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
												<div class="icon">
													<i class="mdi mdi-earth" />
												</div>
												<textarea class="scroll scroll2 Treatment" type="text" placeholder="Treatment" style="padding: 8px 8px 8px 0px; line-height: 1.15; min-height:30px;"/>
											</div>
										</div>
									</div>
								</div>
								
								<div class="FlexDisplay FlexGrow FlexColumn"  >
									<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Consultation Notes</h4>
										</div>
									</div>
									<div class="FlexDisplay FlexRow"  style="width:100%; height:calc(100% - 16px); padding:0px 8px;">
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
												<div class="icon">
													<i class="mdi mdi-earth" />
												</div>
												<textarea class="scroll scroll2 Notes" type="text" placeholder="Consultation Notes" style="padding: 8px 8px 8px 0px; line-height: 1.15; min-height:30px;"/>
											</div>
										</div>
									</div>
								</div>
								
								<div class="FlexDisplay FlexGrow FlexColumn"  >
									<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Remarks</h4>
										</div>
									</div>
									<div class="FlexDisplay FlexRow"  style="width:100%; height:calc(100% - 16px); padding:0px 8px 8px 8px;">
										<div class="FlexDisplay Flex FlexGrow-2" style="min-width:260px;">
											<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 4px;">
												<div class="icon">
													<i class="mdi mdi-earth" />
												</div>
												<textarea class="scroll scroll2 Remarks" type="text" placeholder="Remarks" style="padding: 8px 8px 8px 0px; line-height: 1.15; min-height:30px;"/>
											</div>
										</div>
									</div>
								</div>
							
							
							
							
							</div>
						</div>		
					</div>
					
				</div>
			</div>
		</div>
	</div>
</div>
<script>

$('#backBtn').click(function(){
	var page = System.IO.Path.Combine("web","bhis","views",backNavigation);
	loadSubPage(System.IO.Path.Combine(System.Environment.get_CurrentDirectory(),page), true);
});

function filterConsultation(item,event){

}

function removePendingConsultation(item,event){
	event.stopPropagation();
	
	$(item).parent().remove();
	clearData();
	$('.HistoryList').html('');	
	
	$('.FirstName').val('');
	$('.MiddleName').val('');
	$('.LastName').val('');
	
	$('.DateOfBirth').val('');
	$('.PhoneNumber').val('');
	
	$('.Address').val('');
	$('.EmailAddress').val('');
	 
	$('.gender').find("label").each(function(){
		$(this).removeClass('active');
	}); 
	
	$("#addTests").removeClass("FlexDisplay");
	$("#addPrescriptions").removeClass("FlexDisplay");
	
	$(".clear").unbind( "click" );
}

function selectPendingConsultation(el, item){
	$(".ConsultationPendingList .CheckBoxBold").each(function(){
		$(this).removeClass('Checked');
	});

	el.addClass('Checked');
	
	$('.HistoryList').html('');
	$('.TestsList').html('');
	$('.PrescriptionsList').html('');
	
	fetchData(item.RequestID);
		
	$("#addTests").addClass("FlexDisplay");
	$("#addPrescriptions").addClass("FlexDisplay");
	
	$(".clear").unbind( "click" );
	$(".clear").click(function(){	
		$(".search .submenu").hide();
		$(".search").attr('id', '');
		
		$(".save .submenu").hide();
		$(".save").attr('id', '');
		
		$(".HistoryList .CheckBoxBold").each(function(){
			$(this).removeClass('Checked');
		});
		
		clearData();
		
	});
	
	
}

function selectHistoryList(el, item){
	$(".HistoryList .CheckBoxBold").each(function(){
		$(this).removeClass('Checked');
	});
	
	el.addClass('Checked');
	
	$('.TestsList').html('');
	$('.PrescriptionsList').html('');	
		
	var requestID = $(".ConsultationPendingList .CheckBoxBold.Checked").data('id');
	if(!isEmpty(requestID)){
		var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
		if(con != null){
			con.open();
			
			var query  = "SELECT ";
				query += " `ConsultedBy` ";
				query += " ,`Examination` ";
				query += " ,`Treatment` ";
				query += " ,`Notes` ";
				query += " ,`Remarks` ";
				query += "FROM `Consultation` ";
				query += "WHERE `RequestID` = @ID ";
				query += "AND `ConsultationDateTime` = @DT ";
				query += "LIMIT 1 ";
				
			var comm = con.createCommand(query);
			if(comm != null){
				comm.addParameter("@ID", "String", requestID);
				comm.addParameter("@DT", "String", item.ConsultationDateTime);
				
				var reader = comm.executeReader();
				if(reader != null){
					if(reader.read()){
						var row = JSON.parse(reader.getValues());	
						if(row != undefined && row != null){
							$(".Examination").val(row.Examination);
							$(".Treatment").val(row.Treatment);
							$(".Notes").val(row.Notes);
							$(".Remarks").val(row.Remarks);
						}
						
						$("#addTests").removeClass("FlexDisplay");
						$("#addPrescriptions").removeClass("FlexDisplay");
						
						showingHistory = true;
					}
					reader.close();
				}
			}
			
			var query  = "SELECT ";
				query += " `ID` ";
				query += " ,`OBRSetID` ";
				query += " ,`LIMSPanelCode` ";
				query += " ,`LIMSPanelDesc` ";
				query += " ,`WorkUnits` ";
				query += " ,`CostUnits` ";
				query += " ,`HL7SectionCode` ";
				query += " ,`LIMSRejectionCode` ";
				query += " ,`LIMSRejectionDesc` ";
				query += " ,`LIMSRejectedBy` ";
				query += "FROM `Request` ";
				query += "WHERE `RequestID` = @ID ";
				query += "AND `ConsultationDateTime` = @DT ";
				//query += "LIMIT 1 ";
				
			var comm = con.createCommand(query);
			if(comm != null){
				comm.addParameter("@ID", "String", requestID);
				comm.addParameter("@DT", "String", item.ConsultationDateTime);
				
				var reader = comm.executeReader();
				if(reader != null){
					while(reader.read()){
						var row = JSON.parse(reader.getValues());	
						if(row != undefined && row != null){
							addTest(false, {
								PK:row.ID,
								ID:row.OBRSetID,
								Name:row.LIMSPanelCode,
								Description:row.LIMSPanelDesc,
								LabSection:row.HL7SectionCode,
								CostToPatient:row.CostUnits,
								RejectionCode:row.LIMSRejectionCode,
								RejectionDescription:row.LIMSRejectionDesc,
								RejectedBy:row.LIMSRejectedBy
							});
						}
					}
					reader.close();
				}
			}
			con.close();
		}
	}
	
	
}

function updateTestCost(){
	var total = 0;
	$('.TestsList').children().each(function(){		
		var isRejected = !isEmpty($(this).data('rejectioncode'));
		if(!isRejected)total += parseFloat($(this).data("price"));
	});
	$(".testsTitle").html("TESTS - "+total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
}

function updatePrescriptionCost(){
	var total = 0;
	$('.PrescriptionsList').children().each(function(){
		total += parseFloat($(this).data("price"));
	});
	$(".prescriptionsTitle").html("MEDS - "+total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
}

function addPendingConsultation(item){
	var index = $('.consultationindex').last().text();
	if(index.length == 0)index = 1;
	else index = parseInt($('.consultationindex').last().text())+1;
	
	var new_consultation = item.RequestID+' : '+item.PatientName+(!isEmpty(item.PatientMiddleName) ? ' '+item.PatientMiddleName[0].toUpperCase()+'.' : '')+' '+item.PatientLastName;
	
	
	var consultation  = '<div data-id="'+item.RequestID+'" class="FlexDisplay FlexRow Divider-Bottom CheckBoxBold" style="min-height:32px;">';
		consultation += '	<div class="FlexDisplay FlexRow Divider-Right" style="min-height:32px; min-width:40px; max-width:40px;">';
		consultation += '		<h4 class="consultationindex feature-title mt-0" style="width:100%; margin:2px 0px 0px 0px; font-size: 10px; font-weight:normal; text-align:center;">'+(index)+'</h4>';
		consultation += '	</div>';
		consultation += '	<div class="FlexDisplay Flex FlexRow Divider-Right" style="min-height:32px; min-width:128px;">';
		consultation += '		<h4 class="feature-title mt-0" style="margin:0px 12px 0px 12px; font-size: 11px; font-weight:normal;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+new_consultation+'</h4>';
		consultation += '	</div>';
		consultation += '	<div class="FlexDisplay btn-clear" onclick="removePendingConsultation(this,event)">';
		consultation += '		<div style="margin:auto auto; width:16px height:16px; padding:0px 12px; font-size: 14px;"><i class="mdi mdi-close-circle" /></div>';
		consultation += '	</div>';
		consultation += '</div>';
	
	var el = $(consultation);
	$('.ConsultationPendingList').append(el);
	
	el.unbind( "click" );
	el.click(function(){	
		selectPendingConsultation($(this), item);
	});

	
	updatePrescriptionCost();
}

function addHistory(item, selected){
	var index = $('.historyindex').last().text();
	if(index.length == 0)index = 1;
	else index = parseInt($('.historyindex').last().text())+1;
	
	var isSelected = selected != undefined && selected != null && selected;
	
	if(isSelected){
		$(".HistoryList .CheckBoxBold").each(function(){
			$(this).removeClass('Checked');
		});
	}
	
	var history  = '<div data-by="'+item.ConsultedBy+'" data-date="'+item.ConsultationDateTime+'" class="FlexDisplay FlexRow Divider-Bottom CheckBoxBold '+(isSelected ? 'Checked' : '')+'" style="min-height:32px;">';
		history += '	<div class="FlexDisplay FlexRow Divider-Right" style="min-height:32px; min-width:40px; max-width:40px;">';
		history += '		<h4 class="historyindex feature-title mt-0" style="width:100%; margin:2px 0px 0px 0px; font-size: 10px; font-weight:normal; text-align:center;">'+(index)+'</h4>';
		history += '	</div>';
		history += '	<div class="FlexDisplay Flex FlexRow" style="min-height:32px; min-width:118px;">';
		history += '		<h4 class="feature-title mt-0" style="margin:0px 12px 0px 12px; font-size: 11px; font-weight:normal;">'+item.ConsultationDateTime+'</h4>';
		history += '	</div>';
		history += '	<div class="FlexDisplay FlexRow Divider-Left" style="min-height:32px; min-width:40px; max-width:40px;">';
		history += '		<div tooltip="pending" flow="left" class="FlexDisplay" style="width:100%; height:100%; padding:0px 0px 0px 0px;"><span style="text-align:center; display:inline-block; width:100%;"><i class="mdi mdi-information"></i></span></div>';
		history += '	</div>';
		
		history += '</div>';
		
	var el = $(history);
	$('.HistoryList').append(el);
	
	el.unbind( "click" );
	el.click(function(){	
		selectHistoryList($(this), item);
	});
}

function removeTest(item){
	$(item).parent().remove();
	updateTestCost();
}

function removePrescription(item){
	$(item).parent().remove();
	updatePrescriptionCost();
}

function addTest(canDelete, item){
	var index = $('.testindex').last().text();
	if(index.length == 0)index = 1;
	else index = parseInt($('.testindex').last().text())+1;
	
	var isRejected = item.hasOwnProperty('RejectionCode') && !isEmpty(item.RejectionCode);
	/*var tp = parseFloat(item.CostToPatient).toFixed(2);
	if(isRejected){
		var sentences = splitWords(item.RejectionDescription.split(' '), "", [], 20);		
		tp = item.RejectionCode+'&#13;&#10;';
		tp += '--------------------------&#13;&#10;';
		tp += sentences.join('&#13;&#10;')+'&#13;&#10;';
		tp += '--------------------------&#13;&#10;';
		tp += item.RejectedBy;
	}*/
	 
	var test  = '<div data-rejectioncode="'+item.RejectionCode+'" data-rejectiondescription="'+item.RejectionDescription+'" data-rejectedby="'+item.RejectedBy+'" data-id="'+item.ID+'" data-name="'+item.Name+'" data-description="'+item.Description+'" data-labsection="'+item.LabSection+'" data-price="'+parseFloat(item.CostToPatient).toFixed(2)+'" class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px; ">';
		test += '	<div class="FlexDisplay FlexRow Divider-Right TestButton" style="min-height:32px; min-width:40px; max-width:40px; cursor:pointer;">';
		test += '		<div  class="FlexDisplay" style="width:100%; height:100%; padding:2px 0px 0px 2px;;"><span style="text-align:center; display:inline-block; width:100%; '+(isRejected ? 'color:#c4183c;' : '')+'"><i class="mdi mdi-information"></i></span></div>';
		test += '	</div>'; //tooltip="'+tp+'" flow="right" '+(isRejected ? 'wrap="pre" resize="128" recolor="red"' : '')+'
		test += '	<div class="FlexDisplay Flex FlexRow Divider-Right" style="min-height:32px; min-width:128px;">';
		test += '		<h4 class="feature-title mt-0" style="margin:0px 12px 0px 12px; font-size: 11px; font-weight:normal;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+item.Name+' - '+item.LabSection+'</h4>';
		test += '	</div>';
		if(canDelete){
			test += '	<div class="FlexDisplay btn-clear" onclick="removeTest(this)">';
			test += '		<div style="margin:auto auto; width:16px height:16px; padding:0px 12px; font-size: 14px;"><i class="mdi mdi-close-circle" /></div>';
			test += '	</div>';
		}
		test += '</div>';
	
	var t = $(test);
	$('.TestsList').append(t);
	
	
	t.find('.TestButton').unbind( "click" );
	t.find('.TestButton').click(function(){
		var pk = item.PK;
		var testID = item.ID;
		var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_dict.db"),"","");
		if(con != null){
			con.open();
			
			var query   = "SELECT ";
				query  += "`ID` ";
				query  += ",`ParentID` ";
				query  += ",`Type` ";
				query  += ",`Name` ";
				query  += ",IFNULL(`UnitDefault`,'') as `UnitDefault` ";
				query  += "FROM `measurements` "; 
				query  += "WHERE `TestID` = @TestID ";
			
			var comm = con.createCommand(query);
			if(comm != null){
				comm.addParameter("@TestID", "Int32", testID);
				var reader = comm.executeReader();
				if(reader != null){
					var messurements = [];
					
					while(reader.read()){
						var row = JSON.parse(reader.getValues());	
						if(row != undefined && row != null){
							row.Information = [];
							row.SubMessurements = [];
							//row.Index = pk;
							messurements.push(row);
						}
					}
					reader.close();
					
					var query   = "SELECT ";
						query  += "`Index` ";
						query  += ",`TestID` ";
						query  += ",`MeasurementID` ";
						query  += ",`Setting` ";
						query  += ",IFNULL(`Value`,'') as `Value` ";
						query  += "FROM `measurement_options` "; 
						query  += "WHERE `TestID` = @TestID ";
						query  += "ORDER BY `Index`";
						
					var comm = con.createCommand(query);
					if(comm != null){
						comm.addParameter("@TestID", "Int32", testID);
						var reader = comm.executeReader();
						if(reader != null){
							
							while(reader.read()){
								var row = JSON.parse(reader.getValues());	
								if(row != undefined && row != null){
									var messurement = messurements.filter(function(v){ return v.ID == row.MeasurementID; }).shift();
									if(messurement != undefined && messurement != null)messurement.Information.push(row);
								}
							}
							reader.close();
						}
					}
					
					messurements.forEach(function(messurement){
						messurement.Information = messurement.Information.reduce(function(obj, { Index, Setting, Value }, index) {
							if(obj[Index-1] == undefined || obj[Index-1] == null)obj[Index-1]=[];									
							obj[Index-1].push({Setting, Value });
							return obj;
						}, []);
						
						if(messurement.Type == "Autocomplete"){
							if(messurement.Information.length > 0){
								messurement.Information = messurement.Information.shift();
							}
						}
						else{
							messurement.Information = messurement.Information.map(function(info) {
								return info.reduce(function(obj, { Setting, Value }, index) {
									obj[Setting] = Value;
									return obj;
								}, {});
							});
						}
					});
					
					
					var subs = messurements.filter(function(v){ return v.ParentID != undefined && v.ParentID != null; });
					messurements = messurements.filter(function(v){ return v.ParentID == undefined || v.ParentID == null; });

					subs.forEach(function(sub){
						var messurement = messurements.filter(function(v){ return v.ID == sub.ParentID; }).shift();
						if(messurement != undefined && messurement != null){
							messurement.SubMessurements.push(sub);
						}
					});					
					con.close();
					
					var requestID = $(".ConsultationPendingList .CheckBoxBold.Checked").data('id');	
					var Results = [];
					
					var _con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
					if(_con != null){
						_con.open();
						
						var query = "SELECT ";
							query += "	`ID`";
							query += "	,`DateTimeStamp`";
							query += "	,`Versionstamp`";
							query += "	,`RequestID`";
							query += "	,`OBRSetID`";
							query += "	,`OBXSetID`";
							query += "	,`OBXSubID`";
							query += "	,`LIMSObservationCode`";
							query += "	,`LIMSObservationDesc`";
							query += "	,`LIMSRptResult`";
							query += "	,`LIMSRptUnits`";
							query += "	,`AnalysisDateTime`";
							query += "	,`TestedBy` ";
							query += "FROM `Result` ";
							query += "WHERE `RequestID` = @RequestID ";
							query += "AND `OBRSetID` = @OBRSetID ";
							query += "AND `OBXSubID` = @OBXSubID ";
						var _comm = _con.createCommand(query);
						if(_comm != null){
							_comm.addParameter("@RequestID", "String", requestID);
							_comm.addParameter("@OBRSetID", "Int32", testID);
							_comm.addParameter("@OBXSubID", "Int32", pk);
							var _reader = _comm.executeReader();
							if(_reader != null){
								while(_reader.read()){
									var row = JSON.parse(_reader.getValues());	
									if(row != undefined && row != null){
										Results.push(row);
									}
								}
								_reader.close();
							}
						}						
						_con.close();
					}
					
					//if(messurements.length > 0){
						var content = '';
							content += '<div class="bar-container" style="margin:0px;">';
							content += '	<div class="bar-progress"></div>';
							content += '</div>';
							
							content += '<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox" style="width:100%;">';	
							content += '	<div class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox scroll scroll2 TestList" style="overflow-y:auto; max-height:256px;">';	
							content += '	</div>';	
							content += '</div>';


						var test_dlg = ShowDialog('<i class="mdi mdi-flask-outline"></i>', "Test", content,{
							onCloseDialog : function() {
								test_dlg = null;
								return false; 
							}
						},"720px","720px");
						
						var testList = $(test_dlg.el).find('.TestList');
						
						var test  = '<div data-rejectioncode="'+item.RejectionCode+'" data-rejectiondescription="'+item.RejectionDescription+'" data-rejectedby="'+item.RejectedBy+'" data-id="'+item.ID+'" data-name="'+item.Name+'" data-requestid="'+item.RequestID+'" data-consultationdatetime="'+item.ConsultationDateTime+'" class="FlexDisplay FlexColumn FlexBoxSizing-BorderBox TestingItem '+(!isEmpty(item.RejectionCode) ? 'Rejected' : '')+'" style="width:100%; margin:0px 0px 0px 0px;">';
							test += '	<div class="FlexDisplay FlexRow Title" style="min-height:32px;max-height:32px;margin:0px 0px 0px 0px;" >';
							test += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
							test += '			<h4 class="feature-title mt-0" style="margin:8px 0px 8px 10px; font-size: 12px; font-weight:normal; line-height:16px;">'+item.Name+'</h4>';
							test += '		</div>';
							test += '		<div tooltip="'+(!isEmpty(item.RejectionCode) ? item.RejectionCode +' - '+item.RejectionDescription : 'Costs: TSH'+parseFloat(item.CostToPatient).toFixed(2))+'" flow="left" class="FlexDisplay btn-clear">';
							test += '			<div style="margin:auto auto; width:14px height:14px; padding:0px 14px; font-size:14px;"><i class="mdi mdi-information" /></div>';
							test += '		</div>';
							test += '	</div>';
							test += '</div>';	
						
						var testEl = $(test);
						
						
						
						
						var ts = Results.filter(function(v){ return v.RequestID == requestID && v.OBRSetID == testID && v.OBXSubID == pk; });
						
						messurements.forEach(function(messurement, index){
								if(messurement.Type == "Alphanumeric Values"){
									var value = null;
									var t = ts.filter(function(v){ return v.LIMSObservationDesc == messurement.Name; }).shift();
									if(t != undefined && t != null && !isEmpty(t.LIMSRptResult)){
										value=t.LIMSRptResult;
									}
									
									var paramters  = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
										paramters += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
										paramters += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
										paramters += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">'+messurement.Name+'</h4>';
										paramters += '			</div>';
										paramters += '		</div>';
										paramters += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
										paramters += '			<div class="FlexDisplay Flex FlexRow form-control">';
										paramters += '				<div class="icon" tooltip="'+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? " "+messurement.UnitDefault.trim() : "" )+'" flow="left">';
										paramters += '					<i class="mdi '+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? "mdi-information" : "mdi-progress-alert" )+'" />';
										paramters += '				</div>';
										paramters += '				<select class="ResultDropDown">';
										paramters += '					<option '+(value == null ? 'selected=""' : '')+'>Choose...</option>';
										messurement.Information.forEach(function(information){
											paramters += '<option '+(value != null && value == information.From ? 'selected=""' : '')+'>'+information.From+'</option>';
											if(information.To != undefined && information.To != null)
												paramters += '<option '+(value != null && value == information.To ? 'selected=""' : '')+'>'+information.To+'</option>';
										});
										paramters += '				</select>';
										paramters += '			</div>';
										paramters += '		</div>';
										paramters += '	</div>';
									
									var paramtersEl = $(paramters);
									testEl.append(paramtersEl);
									
									paramtersEl.find(".ResultDropDown").unbind( "change" );
									paramtersEl.find(".ResultDropDown").on('change', function (e) {
										//var optionSelected = $("option:selected", this);
										if(isEmpty(item.RejectionCode)){
											updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptResult', this.value);
											updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptUnits', messurement.UnitDefault);
											
											updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
											updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
										}
									});
								}
								else if(messurement.Type == "Numeric Range"){
									var information = messurement.Information.filter(function(i){ return i.Gender.toLowerCase() == "male"; }).shift();
									if(information != undefined && information != null){
										var value = null;
										var t = ts.filter(function(v){ return v.LIMSObservationDesc == messurement.Name; }).shift();
										if(t != undefined && t != null && !isEmpty(t.LIMSRptResult)){
											value=t.LIMSRptResult;
										}
										
										var paramters  = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
											paramters += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
											paramters += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
											paramters += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">'+item.Name+'</h4>';
											paramters += '			</div>';
											paramters += '		</div>';
											paramters += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
											paramters += '			<div class="FlexDisplay Flex FlexRow form-control">';
											paramters += '				<div class="icon" tooltip="('+information.From+'-'+information.To+')'+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? " "+messurement.UnitDefault.trim() : "" )+'" flow="left">';
											paramters += '					<i class="mdi mdi-information" />';
											paramters += '				</div>';
											paramters += '				<input value="'+(value != null ? value : '')+'" class="ResultInput" type="text" placeholder="'+messurement.Name+'"/>';
											paramters += '			</div>';
											paramters += '		</div>';
											paramters += '	</div>';
										
										var paramtersEl = $(paramters);
										testEl.append(paramtersEl);
										
										paramtersEl.find(".ResultInput").unbind( "change" );
										paramtersEl.find(".ResultInput").on('change', function (e) {
											if(isEmpty(item.RejectionCode)){
												updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptResult', this.value);
												updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptUnits', messurement.UnitDefault);
												
												updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
												updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
											}
										});
									}
								}
								else if(messurement.Type == "Autocomplete"){
									var value = null;
									var t = ts.filter(function(v){ return v.LIMSObservationDesc == messurement.Name; }).shift();
									if(t != undefined && t != null && !isEmpty(t.LIMSRptResult)){
										value=t.LIMSRptResult;
									}
									
									var paramters  = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
										paramters += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
										paramters += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
										paramters += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">'+messurement.Name+'</h4>';
										paramters += '			</div>';
										paramters += '		</div>';
										paramters += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
										paramters += '			<div class="FlexDisplay Flex FlexRow form-control">';
										paramters += '				<div class="icon" tooltip="'+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? " "+messurement.UnitDefault.trim() : "" )+'" flow="left">';
										paramters += '					<i class="mdi '+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? "mdi-information" : "mdi-progress-alert" )+'" />';
										paramters += '				</div>';
										paramters += '				<select class="ResultDropDown">';
										paramters += '					<option '+(value == null ? 'selected=""' : '')+'>Choose...</option>';
										messurement.Information.forEach(function(information){
											paramters += '<option '+(value != null && value == information.Value ? 'selected=""' : '')+'>'+information.Value+'</option>';
										});
										paramters += '				</select>';
										paramters += '			</div>';
										paramters += '		</div>';
										paramters += '	</div>';
										
									var paramtersEl = $(paramters);
									testEl.append(paramtersEl);
									
									paramtersEl.find(".ResultDropDown").unbind( "change" );
									paramtersEl.find(".ResultDropDown").on('change', function (e) {
										if(isEmpty(item.RejectionCode)){
											updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptResult', this.value);
											updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptUnits', messurement.UnitDefault);
											
											updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
											updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
										}
									});
								}
								else if(messurement.Type == "Free Text"){
									var information = messurement.Information.filter(function(i){ return i.Gender.toLowerCase() == "male"; }).shift();
									if(information != undefined && information != null){
										var value = null;
										var t = ts.filter(function(v){ return v.LIMSObservationDesc == messurement.Name; }).shift();
										if(t != undefined && t != null && !isEmpty(t.LIMSRptResult)){
											value=t.LIMSRptResult;
										}
										
										var paramters  = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
											paramters += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
											paramters += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
											paramters += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">'+item.Name+'</h4>';
											paramters += '			</div>';
											paramters += '		</div>';
											paramters += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
											paramters += '			<div class="FlexDisplay Flex FlexRow form-control">';
											paramters += '				<div class="icon" tooltip="('+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? " "+messurement.UnitDefault.trim() : "" )+'" flow="left">';
											paramters += '					<i class="mdi '+(messurement.UnitDefault != undefined && messurement.UnitDefault != null && messurement.UnitDefault.trim() != "" ? "mdi-information" : "mdi-progress-alert" )+'" />';
											paramters += '				</div>';
											paramters += '				<input value="'+(value != null ? value : '')+'" class="ResultInput" type="text" placeholder="'+messurement.Name+'"/>';
											paramters += '			</div>';
											paramters += '		</div>';
											paramters += '	</div>';
											
										var paramtersEl = $(paramters);
										testEl.append(paramtersEl);
										
										paramtersEl.find(".ResultInput").unbind( "change" );
										paramtersEl.find(".ResultInput").on('change', function (e) {
											if(isEmpty(item.RejectionCode)){
												updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptResult', this.value);
												updateResult(pk, testID, currentTest.Name, messurement.Name, 'LIMSRptUnits', messurement.UnitDefault);
												
												updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
												updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
											}
										});
									}
								}
						});
						
						var iValue = null;
						var rValue = null;
						var _t = ts.filter(function(v){ return v.LIMSObservationDesc == 'Interpretation'; }).shift();
						if(_t != undefined && _t != null && !isEmpty(_t.LIMSRptResult)){ iValue=_t.LIMSRptResult; }
						_t = ts.filter(function(v){ return v.LIMSObservationDesc == 'Remarks'; }).shift();
						if(_t != undefined && _t != null && !isEmpty(_t.LIMSRptResult)){ rValue=_t.LIMSRptResult; }
						
						var result = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
							result += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
							result += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
							result += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">Result:</h4>';
							result += '			</div>';
							result += '		</div>';
							result += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
							result += '			<div class="FlexDisplay Flex FlexRow form-control">';
							result += '				<div class="icon">';
							result += '					<i class="mdi mdi-flask" />';
							result += '				</div>';
							result += '				<input value="'+(iValue != null ? iValue : '')+'" class="ResultInterpretationInput" type="text" placeholder="Interpretation"/>';
							result += '			</div>';
							result += '		</div>';
							result += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
							result += '			<div class="FlexDisplay Flex FlexRow form-control">';
							result += '				<div class="icon">';
							result += '					<i class="mdi mdi-flask" />';
							result += '				</div>';
							result += '				<input value="'+(rValue != null ? rValue : '')+'" class="ResultRemarksInput" type="text" placeholder="Remarks (Optional)"/>';
							result += '			</div>';
							result += '		</div>';
							result += '	</div>';
						var resultEl = $(result);
						
						resultEl.find(".ResultInterpretationInput").unbind( "change" );
						resultEl.find(".ResultInterpretationInput").on('change', function (e) {
							if(isEmpty(item.RejectionCode)){
								updateResult(pk, testID, currentTest.Name, 'Interpretation', 'LIMSRptResult', this.value);
								updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
								updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
							}
						});
						
						resultEl.find(".ResultRemarksInput").unbind( "change" );
						resultEl.find(".ResultRemarksInput").on('change', function (e) {
							if(isEmpty(item.RejectionCode)){
								updateResult(pk, testID, currentTest.Name, 'Remarks', 'LIMSRptResult', this.value);
								updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', receivedEl.find(".datepicker-range-received-in-lab").val());
								updateResult(pk, testID, currentTest.Name, '', 'TestedBy', receivedEl.find(".ResultedBy").val());
							}
						});
						
						
						var recValue = null;
						var byValue = null;
						var _t = ts.filter(function(v){ return !isEmpty(v.AnalysisDateTime); }).shift();
						if(_t != undefined && _t != null){ recValue=_t.AnalysisDateTime; }
						_t = ts.filter(function(v){ return !isEmpty(v.TestedBy); }).shift();
						if(_t != undefined && _t != null){ byValue=_t.TestedBy; }
						
						
						var received  = '	<div class="Locked FlexDisplay FlexRow Testing" style="min-height:44px;max-height:44px;margin:0px 8px 0px 0px;" >';
							received += '		<div class="FlexDisplay Divider-Right" style="margin:0px 0px 0px 0px;">';
							received += '			<div class="FlexDisplay" style="min-width:256px;max-width:256px;min-height:16px;max-height:16px;margin:16px 0px 0px 0px;">';
							received += '				<h4 class="feature-title mt-0" style="margin:0px 0px 0px 10px; font-size: 12px; font-weight:normal; line-height:16px;">Received In Lab:</h4>';
							received += '			</div>';
							received += '		</div>';
							received += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
							received += '			<div class="FlexDisplay Flex FlexRow form-control">';
							received += '				<div class="icon">';
							received += '					<i class="mdi mdi-calendar-outline" />';
							received += '				</div>';
							received += '				<input value="'+(recValue != null ? recValue : '')+'" type="text" placeholder="dd/mm/yyyy hh:mm" class="datepicker-range-received-in-lab" style="padding:0px 0px 0px 8px;"/>';
							received += '			</div>';
							received += '		</div>';
							received += '		<div class="FlexDisplay Flex" style="min-width:150px; margin:8px 0px 4px 8px;">';
							received += '			<div class="FlexDisplay Flex FlexRow form-control">';
							received += '				<div class="icon">';
							received += '					<i class="mdi mdi-doctor" />';
							received += '				</div>';
							received += '				<input value="'+(byValue != null ? byValue : '')+'" class="ResultedBy" type="text" placeholder="By"/>';
							received += '			</div>';
							received += '		</div>';
							received += '	</div>';
						var receivedEl = $(received);
						
						
						var received_in_lab_datepicker = InitDatePicker(receivedEl.find(".datepicker-range-received-in-lab"), {
							language: 'en',
							dateFormat: 'yyyy-mm-dd',
							timepicker: true, 
							timeFormat: 'hh:ii', 
							position: "top left",
							maxDate:new Date(),
							////startDate:new Date(),
							//onShow:function(inst, animationCompleted){
							//	if(animationCompleted)inst.update('maxDate', new Date());
							//},
							//onSelect:function(formattedDate, date, inst){
							//	if(isEmpty(item.RejectionCode))updateResult(pk, testID, currentTest.Name, '', 'AnalysisDateTime', formattedDate);
							//}
						});
						//received_in_lab_datepicker.selectDate(new Date());
						
						receivedEl.find(".ResultedBy").unbind( "change" );
						//receivedEl.find(".ResultedBy").on('change', function (e) {
						//	if(isEmpty(item.RejectionCode))updateResult(pk, testID, currentTest.Name, '', 'TestedBy', this.value);
						//});
						
						var spacer  = '	<div class="FlexDisplay FlexRow Spacer" style="min-height:8px;max-height:8px;" >';
							spacer += '		<div class="FlexDisplay Divider-Right" style="min-width:257px;max-width:257px;"></div>';
							spacer += '	</div>';
						var spacerEl = $(spacer);
						
						testEl.append(resultEl);
						testEl.append(receivedEl);
						testEl.append(spacerEl);
						
						testList.append(testEl);
						
						create_custom_dropdowns();
						
						var resultDropDowns = testList.find(".select-dropdown.ResultDropDown .list");//.find(".list");
						if(resultDropDowns != undefined && resultDropDowns != null){
							resultDropDowns.addClass("scroll scroll2");
							resultDropDowns.css({"overflow-y": "auto", "max-height": "200px"});
						}
					//}
				}
			}	
			else con.close();
		}
	});
	
	updateTestCost();
}

function addPrescription(canDelete, item){
	var index = $('.prescriptionindex').last().text();
	if(index.length == 0)index = 1;
	else index = parseInt($('.prescriptionindex').last().text())+1;
		
	var prescription  = '<div data-id="'+item.ID+'" data-price="'+parseFloat(item.CostToPatient).toFixed(2)+'" class="FlexDisplay FlexRow Divider-Bottom" style="min-height:32px;">';
		prescription += '	<div class="FlexDisplay FlexRow Divider-Right" style="min-height:32px; min-width:40px; max-width:40px;">';
		prescription += '		<div tooltip="'+parseFloat(item.CostToPatient).toFixed(2)+'" flow="right" class="FlexDisplay" style="width:100%; height:100%; padding:2px 0px 0px 2px;"><span style="text-align:center; display:inline-block; width:100%;"><i class="mdi mdi-information"></i></span></div>';
		prescription += '	</div>';
		prescription += '	<div class="FlexDisplay Flex FlexRow Divider-Right" style="min-height:32px; min-width:128px;">';
		prescription += '		<h4 class="feature-title mt-0" style="margin:0px 12px 0px 12px; font-size: 11px; font-weight:normal;white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+item.Name+'</h4>';
		prescription += '	</div>';
		if(canDelete){
			prescription += '	<div class="FlexDisplay btn-clear" onclick="removePrescription(this)">';
			prescription += '		<div style="margin:auto auto; width:16px height:16px; padding:0px 12px; font-size: 14px;"><i class="mdi mdi-close-circle" /></div>';
			prescription += '	</div>';
		}
		prescription += '</div>';
	
	$('.PrescriptionsList').append(prescription);
}

function clearData(){
	$('.TestsList').html('');
	$('.PrescriptionsList').html('');
	
	$('.Examination').val('');
	$('.Treatment').val('');
	$('.Notes').val('');
	$('.Remarks').val('');
	
	$("#addTests").addClass("FlexDisplay");
	$("#addPrescriptions").addClass("FlexDisplay");
	
	updateTestCost();
	updatePrescriptionCost();
	
	showingHistory = false;
}

function getSamplesTypes(){
	var samplesTypes = [];
	var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_dict.db"),"","");
	if(con != null){
		con.open();

		var query  = "SELECT ";
			query += "	`ID` ";
			query += "	, `Name` ";
			query += "	, `Description` ";
			query += "FROM `specimen_types` ";
				
		var comm = con.createCommand(query);
		if(comm != null){
			var reader = comm.executeReader();
			if(reader != null){
				while(reader.read()){
					var row = JSON.parse(reader.getValues());	
					if(row != undefined && row != null){
						samplesTypes.push(row);
					}
				}
				reader.close();
				con.close();				
			}
			else con.close();
		}
		else con.close();
	}
	
	return samplesTypes;
}

function getTests(id){
	var tests = [];
	var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_dict.db"),"","");
	if(con != null){
		con.open();

		var query  = "select  ";
			query  += "	`te`.`ID` ";
			query  += "	,`te`.`Name` ";
			query  += "	,`te`.`Description` ";
			query  += "	,`te`.`LabSection` ";
			query  += "	,IFNULL(`te`.`CostToPatient`,0) `CostToPatient` ";
			query  += "from `compatible_specimens` `co` ";
			query  += "inner join `tests` `te` ";
			query  += "on `co`.`TestID` = `te`.`ID` ";
			query  += "where `co`.`SpecimenTypeID` = @ID ";
							
		var comm = con.createCommand(query);
		if(comm != null){
			comm.addParameter("@ID", "Int32", id);
			var reader = comm.executeReader();
			if(reader != null){
				while(reader.read()){
					var row = JSON.parse(reader.getValues());	
					if(row != undefined && row != null){
						row.PK = -1;
						tests.push(row);
					}
				}
				reader.close();
				con.close();				
			}
			else con.close();
		}
		else con.close();
	}
	
	return tests;
}

function fetchData(id){
	if(id != undefined && id != null){
		var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
		if(con != null){
			con.open();
			
			var query  = "SELECT ";
				query += "	 `PatientName`";
				query += "	,`PatientMiddleName`";
				query += "	,`PatientLastName`";
				query += "	,`PatientAge`";
				query += "	,`HL7SexCode`";
				query += "	,`PhoneNumber`";
				query += "	,`Address`";
				query += "	,`Email`";
				query += "FROM `Reception` ";
				query += "WHERE (`RequestID` like @ID)";
				query += "LIMIT 1 ";
			
			var comm = con.createCommand(query);
			if(comm != null){
				comm.addParameter("@ID", "String", id);
				
				var reader = comm.executeReader();
				if(reader != null){
					if(reader.read()){
						var row = JSON.parse(reader.getValues());	
						if(row != undefined && row != null){
							$('.FirstName').val(row.PatientName);
							$('.MiddleName').val(row.PatientMiddleName);
							$('.LastName').val(row.PatientLastName);
							
							$('.DateOfBirth').val(row.PatientAge);
							$('.PhoneNumber').val(row.PhoneNumber);
							
							$('.Address').val(row.Address);
							$('.EmailAddress').val(row.Email);
							
							$('.gender').removeClass('is-invalid');
							$('.gender').find("label").each(function(){
								$(this).removeClass('active');
								
								var gender = $(this).find("input").val();
								if(row.HL7SexCode == gender)$(this).addClass('active');
							});
						}
					}
					reader.close();
					
					
					var query  = "SELECT ";
						query += " `ConsultationDateTime` ";
						query += " ,`ConsultedBy` ";
						query += "FROM `Consultation` ";
						query += "WHERE (`RequestID` like @ID)";
						query += "LIMIT 1 ";
						
					var comm = con.createCommand(query);
					if(comm != null){
						comm.addParameter("@ID", "String", id);
						
						var reader = comm.executeReader();
						if(reader != null){
							if(reader.read()){
								var row = JSON.parse(reader.getValues());	
								if(row != undefined && row != null){
									addHistory(row, false);
								}
							}
							reader.close();
						}
					}
					
					con.close();
				}
				else con.close();
			}
			else con.close();
			
			
		}
	}
}

function getConsultations(){
	var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
	if(con != null){
		con.open();
		
		var query  = "SELECT ";
			//query += "	 `DateTimeStamp`";
			//query += "	,`Versionstamp`";
			query += "	`RequestID`";
			//query += "	,`ReferringRequestID`";
			//query += "	,`NationalID`";
			//query += "	,`PatientID`";
			query += "	,`PatientName`";
			query += "	,`PatientMiddleName`";
			query += "	,`PatientLastName`";
			//query += "	,`PatientAge`";
			//query += "	,`HL7SexCode`";
			//query += "	,`PhoneNumber`";
			//query += "	,`Address`";
			//query += "	,`Email`";
			//query += "	,`SpecimenDateTime`";
			//query += "	,`SpecimenCollectedBy`";
			//query += "	,`RegisteredDateTime`";
			//query += "	,`RequestingFacilityCode`";
			//query += "	,`TestingFacilityCode`";
			//query += "	,`RegisteredBy`";
			//query += "	,`RequestTypeCode`";
			//query += "	,`SpecimenCondition`";
			//query += "	,`InsuranceCardNumber`";
			//query += "	,`InsuranceAuthorizationNumber`";
			//query += "	,`InsurancePreliminaryDiagnosisCode`";
			//query += "	,`InsuranceFinalDiagnosisCode`";
			query += "FROM `Reception` ";
			//query += "WHERE (`RequestID` like @ID)";
			query += "ORDER BY `DateTimeStamp` desc ";
			//query += "LIMIT 1 ";
			
		var comm = con.createCommand(query);
		if(comm != null){
			//comm.addParameter("@ID", "String", id);
			
			var reader = comm.executeReader();
			if(reader != null){
				while(reader.read()){
					var row = JSON.parse(reader.getValues());	
					if(row != undefined && row != null){
						 addPendingConsultation(row);
					}
				}
				reader.close();
				con.close();				
			}
			else con.close();
		}
		else con.close();
	}
}

$('input[type=radio][name=gender_options]').change(function() {
	$(this).parents(".btn-group-toggle").find(".active").removeClass('active');
	$(this).parent().addClass('active');
});

$('input[type=radio][name=gender_options]:not(:checked)').attr('disabled', true);

$("#addTests").unbind( "click" );
$("#addTests").click(function(){
	var content = '';
			content += '<div class="bar-container" style="margin:0px;">';
			content += '	<div class="bar-progress"></div>';
			content += '</div>';
			content += '<div class="FlexDisplay FlexColumn" style="width:100%; min-height:128px;  margin:8px 0px 4px 0px;" >';
			
			
			content += '	<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:0px 0px 0px 0px;" >';
			content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
			content += '			<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Specimen Type</h4>';
			content += '		</div>';
			content += '	</div>';
			content += '	<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:2px 8px;">';						
			content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
			content += '			<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 0px;">';
			content += '				<div class="icon">';
			content += '					<i class="mdi mdi-test-tube" />';
			content += '				</div>';
			content += '				<select class="specimenTypes">';
			content += '					<option selected="">...</option>';
			content += '				</select>';
			content += '			</div>';
			content += '		</div>';
			content += '	</div>';
			
			content += '	<div class="FlexDisplay FlexRow" style="min-height:16px;max-height:16px;margin:8px 0px 0px 0px;" >';
			content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
			content += '			<h4 class="feature-title mt-0" style="margin:0px 0px 0px 12px; font-size: 12px; font-weight:normal; line-height:16px;">Tests</h4>';
			content += '		</div>';
			content += '	</div>';
			content += '	<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:2px 8px;">';						
			content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
			content += '			<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 0px;">';
			content += '				<div class="icon">';
			content += '					<i class="mdi mdi-flask" />';
			content += '				</div>';
			content += '				<select class="tests">';
			content += '					<option selected="">...</option>';
			content += '				</select>';
			content += '			</div>';
			content += '		</div>';
			content += '	</div>';
			
			content += '</div>';
			content += '<div class="FlexDisplay FlexRow" style="width:100%; height:auto; margin:4px 0px 8px 0px;" >';
			content += '	<div class="FlexDisplay Flex"></div>';
			content += '	<div class="FlexDisplay FlexRow" style="margin:8px 12px; height:auto;" >';
			content += '			<div class="addTestButton button button-primary" style="margin:0px;">ADD</div>';
			content += '	</div>';
			content += '</div>';
	
	var dlg = ShowDialog('<i class="mdi mdi-flask-plus-outline"></i>', "Add Tests", content);				
	$(dlg.el).find(".addTestButton").unbind( "click" );
	$(dlg.el).find(".addTestButton").click(function() {
		var testname = $(dlg.el).find("select.tests").val();
		if(testname != "..."){
		
			//var test = $(dlg.el).find(".select-dropdown.tests").find(".current").text();
			var id = $(dlg.el).find("select.tests").val();
			var test = tests.filter(function(v){ return v.ID == id;}).shift();
			if(test != undefined && test != null){
				addTest(true, test);
				dlg.toggle();
				dlg = null;
			}
		}
	});
	
	var sampleTypes = getSamplesTypes();
	sampleTypes.forEach(function(element){
		$(dlg.el).find(".specimenTypes").append('<option value="'+element.ID+'">'+element.Name+'</option>');
	});
	
	create_custom_dropdowns();
	
	var _specimenTypes = $(dlg.el).find(".select-dropdown.specimenTypes").find(".list");
	if(_specimenTypes != undefined && _specimenTypes != null){
		_specimenTypes.addClass("scroll scroll2");
		_specimenTypes.css({"overflow-y": "auto", "max-height": "200px"});
	}
	
	var _tests = $(dlg.el).find(".select-dropdown.tests").find(".list");
	if(_tests != undefined && _tests != null){
		_tests.addClass("scroll scroll2");
		_tests.css({"overflow-y": "auto", "max-height": "200px"});
	}
	
	var tests = [];
	$(dlg.el).find(".specimenTypes").change(function() {
		var text = $(this).text();
		if(text != "..."){
			var value = $(this).val();
			
			var _tests = $(dlg.el).find(".select-dropdown.tests");
			if(_tests != undefined && _tests != null){
				_tests.remove();
				
				$(dlg.el).find("select.tests").html('<option selected="">...</option>');
				
				tests = getTests(value);
				tests.forEach(function(element){
					$(dlg.el).find("select.tests").append('<option value="'+element.ID+'">'+element.Name+" - "+element.LabSection+'</option>');
				});
				
				create_custom_dropdowns();
				
				_tests = $(dlg.el).find(".select-dropdown.tests").find(".list");
				if(_tests != undefined && _tests != null){
					_tests.addClass("scroll scroll2");
					_tests.css({"overflow-y": "auto", "max-height": "200px"});
				}
			}
		}
		else{
			$(dlg.el).find("select.tests").html('<option selected="">...</option>');
		}
	});
});

$("#addPrescriptions").unbind( "click" );
$("#addPrescriptions").click(function(){	
	addPrescription(true, {
		ID:0,
		Name:"Prescription",
		CostToPatient:0
	});
});

function hideNavigationDropMenu(){
	$(".search .submenu").hide();
	$(".search").attr('id', '');
	$(".clear .submenu").hide();
	$(".clear").attr('id', '');
	$(".save .submenu").hide();
	$(".save").attr('id', '');
}

$(".search").unbind( "click" );
$(".search").click(function(){
	$(".save .submenu").hide();
	$(".save").attr('id', '');
	
	$(".clear .submenu").hide();
	$(".clear").attr('id', '');
	
	if(!$(".search").hasClass("Disabled")){
		$(".search").addClass("Disabled");
		
		Instascan.Camera.getCameras().then(function (cameras) {
			var content = '';
				content += '<div class="bar-container" style="margin:0px;">';
				content += '	<div class="bar-progress"></div>';
				content += '</div>';
				
				if (cameras.length > 0){
					content += '<div class="FlexDisplay FlexColumn" style="width:100%; min-height:320px;  margin:8px 0px 4px 0px;" >';
					content += '	<div class="FlexDisplay Flex FlexRow Divider-Bottom"  style="width:100%; position:relative; padding:2px 8px;">';
					content += '		<video class="camera_preview" style="background:black; object-fit: cover; min-width:305px; max-width:305px; min-height:270px; max-height:270px"></video>';
					content += '		<div class="preloader-scan">';
					content += '			<div class="diode">';
					content += '				<div class="laser"></div>';
					content += '			</div>';
					content += '		</div>';
					content += '	</div>';

					content += '	<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; padding:2px 8px;">';						
					content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
					content += '			<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 0px; border-radius:2px; ">';
					content += '				<div class="icon">';
					content += '					<i class="mdi mdi-camera" />';
					content += '				</div>';
					content += '				<select class="cameras" onchange="camera_selected(this)">';
					cameras.forEach(function(element, index){
						if(index == 0)content += '					<option value="'+element.id+'" selected="">'+element.name+'</option>';
						else 		  content += '					<option value="'+element.id+'">'+element.name+'</option>';
					});
					content += '				</select>';
					content += '			</div>';
					content += '		</div>';
					content += '	</div>';
				}
				
				content += '	<div class="FlexDisplay FlexRow"  style="width:100%; height:32px; margin-top:8px; margin-bottom:8px; padding:2px 8px;">';						
				content += '		<div class="FlexDisplay Flex" style="min-width:150px;">';
				content += '			<div class="FlexDisplay Flex FlexRow form-control" style="margin:0px 4px 0px 0px; border-radius:2px; ">';	
				content += '				<div class="icon" style="padding-top:0px;">';	
				content += '					<i class="mdi mdi-badge-account-outline" />';	
				content += '				</div>';	
				content += '				<input type="text" placeholder="Name or ID" class="name-id" style="padding:0px 0px 0px 8px;"/>';	
				content += '				<div class="icon btn-color Divider-Left scan"  style="border-radius: 0 0px 0px 0; padding:1px 0px 0px 1px; min-width:32px; max-width:32px;">';
				content += '					<i class="mdi mdi-magnify-scan" />';
				content += '				</div>';
				content += '			</div>';
				content += '		</div>';
				content += '	</div>';
				content += '</div>';
			
			
			var search_dlg = ShowDialog('<i class="mdi mdi-account-group"></i>', "Search", content,{
				onCloseDialog : function() {
					if(scanner != null){
						scanner.stop();
						scanner = null;
						search_dlg = null;
					}
					$(".search").removeClass("Disabled");
					return false; 
				}
			},"320px");	
			
			if (cameras.length > 0){
				scanner = new Instascan.Scanner({
					continuous: true,
					video: $(search_dlg.el).find(".camera_preview").get(0),
					mirror: true,
					captureImage: false,
					backgroundScan: true,
					refractoryPeriod: 5000,
					scanPeriod: 1
				});
				scanner.addListener('scan', function (content) {
					if(content != undefined && content != null){
						
						
						scanner.stop();
						search_dlg.toggle();		
						scanner = null;
						search_dlg = null;
					}		
				});
				
				create_custom_dropdowns();
				scanner.start(cameras[0]);
			}

			$(search_dlg.el).find(".scan").unbind( "click" );
			$(search_dlg.el).find(".scan").click(function() {
				//var result = scanner.scan();
				//console.log(result);
				//console.log(result.content);
				//console.log(result.image);
			});		
		})
		.catch(function (e) {
			console.error(e);
		});
	}
});


$(".save").unbind( "click" );
$(".save").click(function(){	
	$(".search .submenu").hide();
	$(".search").attr('id', '');
	
	$(".clear .submenu").hide();
	$(".clear").attr('id', '');
	
	var requestID = $(".ConsultationPendingList .CheckBoxBold.Checked").data('id');
	if(!isEmpty(requestID)){
		var consultationDateTime = $(".HistoryList .CheckBoxBold.Checked").data('date');
		var isNew = false;
		if(isEmpty(consultationDateTime)){
			var dt = new Date();
			consultationDateTime = `${dt.getFullYear().toString().padStart(4, '0')}-${(dt.getMonth()+1).toString().padStart(2, '0')}-${dt.getDate().toString().padStart(2, '0')}`;
			consultationDateTime += ` ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`; //:${dt.getSeconds().toString().padStart(2, '0')}
			isNew = true;
		}
		
		var examination = $(".Examination").val();
		var treatment = $(".Treatment").val();
		var notes = $(".Notes").val();
		var remarks = $(".Remarks").val();
		
		var dt = new Date();
		var dateTimeStamp = `${dt.getFullYear().toString().padStart(4, '0')}-${(dt.getMonth()+1).toString().padStart(2, '0')}-${dt.getDate().toString().padStart(2, '0')}`;
		dateTimeStamp += ` ${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}:${dt.getSeconds().toString().padStart(2, '0')}`;
		var consultedBy = 'Sys';
		
		if(!isEmpty(examination) && !isEmpty(treatment)){
			if(isNew){
				var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
				if(con != null){
					con.open();
					
					var query = "INSERT INTO `Consultation`(";
						query += "	`DateTimeStamp`";
						query += "	,`Versionstamp`";
						query += "	,`RequestID`";
						query += "	,`ConsultationDateTime`";
						query += "	,`ConsultedBy`";
						query += "	,`Examination`";
						query += "	,`Treatment`";
						if(!isEmpty(notes))query += "	,`Notes`";
						if(!isEmpty(remarks))query += "	,`Remarks`";
						query += ") VALUES (";
						query += "	@DateTimeStamp";
						query += "	,@Versionstamp";
						query += "	,@RequestID";
						query += "	,@ConsultationDateTime";
						query += "	,@ConsultedBy";
						query += "	,@Examination";
						query += "	,@Treatment";
						if(!isEmpty(notes))query += "	,@Notes";
						if(!isEmpty(remarks))query += "	,@Remarks";
						query += ")";
						
					var comm = con.createCommand(query);
					if(comm != null){
						comm.addParameter("@DateTimeStamp", "String", dateTimeStamp);
						comm.addParameter("@Versionstamp", "String", getVersion().toString());
						comm.addParameter("@RequestID", "String", requestID);
						comm.addParameter("@ConsultationDateTime", "String", consultationDateTime);
						comm.addParameter("@ConsultedBy", "String", consultedBy);
						comm.addParameter("@Examination", "String", examination);
						comm.addParameter("@Treatment", "String", treatment);
						if(!isEmpty(notes))comm.addParameter("@Notes", "String", notes);
						if(!isEmpty(remarks))comm.addParameter("@Remarks", "String", remarks);
						comm.executeNonQuery();
						
						$('.TestsList').children().each(function(i){
							var id = parseInt($(this).data("id"));
							var name = $(this).data("name");
							var description = $(this).data("description");
							var labsection = $(this).data("labsection");
							var price = parseFloat($(this).data("price"));
							
							var query = "INSERT INTO `Request`(";
								query += "	`DateTimeStamp`";
								query += "	,`Versionstamp`";
								query += "	,`RequestID`";
								query += "	,`ConsultationDateTime`";
								query += "	,`OBRSetID`";
								query += "	,`LIMSPanelCode`";
								if(!isEmpty(description))query += "	,`LIMSPanelDesc`";
								query += "	,`RegisteredDateTime`";
								query += "	,`CostUnits`";
								query += "	,`HL7SectionCode`";
								query += "	,`LIMSRejectionCode`";
								query += "	,`LIMSRejectionDesc`";
								query += "	,`LIMSRejectedBy`";
									//if(!isEmpty(notes))query += "	,`RequestTypeCode`";
									//if(!isEmpty(notes))query += "	,`ICD10ClinicalInfoCodes`";
									//if(!isEmpty(notes))query += "	,`ClinicalInfo`";
									//if(!isEmpty(notes))query += "	,`HL7SpecimenSourceCode`";
									//if(!isEmpty(notes))query += "	,`LIMSSpecimenSourceCode`";
									//if(!isEmpty(notes))query += "	,`LIMSSpecimenSourceDesc`";								
									//if(!isEmpty(notes))query += "	,`WorkUnits`";
									
									//if(!isEmpty(notes))query += "	,`Repeated`";
								query += ") VALUES (";
								query += "	@DateTimeStamp";
								query += "	,@Versionstamp";
								query += "	,@RequestID";
								query += "	,@ConsultationDateTime";
								query += "	,@OBRSetID";
								query += "	,@LIMSPanelCode";
								if(!isEmpty(description))query += "	,@LIMSPanelDesc";
								query += "	,@RegisteredDateTime";
								query += "	,@CostUnits";
								query += "	,@HL7SectionCode"
								query += "	,@LIMSRejectionCode";
								query += "	,@LIMSRejectionDesc";
								query += "	,@LIMSRejectedBy";
									//if(!isEmpty(notes))query += "	,@RequestTypeCode";
									//if(!isEmpty(notes))query += "	,@ICD10ClinicalInfoCodes";
									//if(!isEmpty(notes))query += "	,@ClinicalInfo";
									//if(!isEmpty(notes))query += "	,@HL7SpecimenSourceCode";
									//if(!isEmpty(notes))query += "	,@LIMSSpecimenSourceCode";
									//if(!isEmpty(notes))query += "	,@LIMSSpecimenSourceDesc";								
									//if(!isEmpty(notes))query += "	,@WorkUnits";
									
									//if(!isEmpty(notes))query += "	,@Repeated";
								query += ")";
								
							var commm = con.createCommand(query);
							if(commm != null){
								commm.addParameter("@DateTimeStamp", "String", dateTimeStamp);
								commm.addParameter("@Versionstamp", "String", getVersion().toString());
								commm.addParameter("@RequestID", "String", requestID);
								commm.addParameter("@ConsultationDateTime", "String", consultationDateTime);
								commm.addParameter("@OBRSetID", "Int32", id);
								commm.addParameter("@LIMSPanelCode", "String", name);
								if(!isEmpty(description))commm.addParameter("@LIMSPanelDesc", "String", description);
								commm.addParameter("@RegisteredDateTime", "String", dateTimeStamp);
								commm.addParameter("@CostUnits", "Double", price);
								commm.addParameter("@HL7SectionCode", "String", labsection);
								commm.addParameter("@LIMSRejectionCode", "String", null);
								commm.addParameter("@LIMSRejectionDesc", "String", null);
								commm.addParameter("@LIMSRejectedBy", "String", null);
								
								//if(!isEmpty(item))commm.addParameter("@RequestTypeCode", "String", item);
								//if(!isEmpty(item))commm.addParameter("@ICD10ClinicalInfoCodes", "String", item);
								//if(!isEmpty(item))commm.addParameter("@ClinicalInfo", "String", item);
								//if(!isEmpty(item))commm.addParameter("@HL7SpecimenSourceCode", "String", item);
								//if(!isEmpty(item))commm.addParameter("@LIMSSpecimenSourceCode", "String", item);
								//if(!isEmpty(item))commm.addParameter("@LIMSSpecimenSourceDesc", "String", item);							
								//if(!isEmpty(item))commm.addParameter("@WorkUnits", "String", item);
								
								//if(!isEmpty(item))commm.addParameter("@Repeated", "String", item);
								commm.executeNonQuery();
							}
						});
						
						
						con.close();
						
						addHistory({ConsultationDateTime:consultationDateTime, ConsultedBy:consultedBy}, true);
					}
					else con.close();				
				}
			}
			else{
				
				var con = new SqlLiteConnection(System.IO.Path.Combine(getRootPath(),"databases","bhis_data.db"),"","");
				if(con != null){
					con.open();
					
					var query = "UPDATE `Consultation` SET";
						query += "	`DateTimeStamp`=@DateTimeStamp";
						query += "	,`Versionstamp`=@Versionstamp";
						query += "	,`ConsultedBy`=@ConsultedBy";
						query += "	,`Examination`=@Examination";
						query += "	,`Treatment`=@Treatment";
						query += "	,`Notes`=@Notes";
						query += "	,`Remarks`=@Remarks";
						query += " WHERE `RequestID`=@RequestID";
						query += " AND `ConsultationDateTime`=@ConsultationDateTime";
						
					var comm = con.createCommand(query);
					if(comm != null){
						comm.addParameter("@DateTimeStamp", "String", dateTimeStamp);
						comm.addParameter("@Versionstamp", "String", getVersion().toString());
						comm.addParameter("@RequestID", "String", requestID);
						comm.addParameter("@ConsultationDateTime", "String", ConsultationDateTime);
						comm.addParameter("@ConsultedBy", "String", consultedBy);
						comm.addParameter("@Examination", "String", examination);
						comm.addParameter("@Treatment", "String", treatment);
						comm.addParameter("@Notes", "String", notes);
						comm.addParameter("@Remarks", "String", remarks);
						comm.executeNonQuery();
						con.close();
					}
					else con.close();				
				}
			}
		}
		else{
		
			if(isEmpty(examination)){
				$(".Examination").parent().addClass("is-invalid");
				$('.Examination').focus(function(){ $(this).parent().removeClass("is-invalid"); });
			}
			
			if(isEmpty(treatment)){
				$(".Treatment").parent().addClass("is-invalid");
				$('.Treatment').focus(function(){ $(this).parent().removeClass("is-invalid"); });
			}
		}
	}
});

$(".search").mouseup(function(){
	return false;
});
$(".clear").mouseup(function(){
	return false;
});
$(".save").mouseup(function(){
	return false;
});
$(".submenu").mouseup(function(){
	return false;
});

$('.search .submenu .root .nav-button').each(function (index, value) {
	$(this).click(function(){
		var text = $(this).text().trim();
		
		
	});
});
$('.clear .submenu .root .nav-button').each(function (index, value) {
	$(this).click(function(){
		
	});
});
$('.save .submenu .root .nav-button').each(function (index, value) {
	$(this).click(function(){
		
	});
});

hideNavigationDropMenu();

getConsultations();

closeLoadingPage();
</script>